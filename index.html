<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×”×›×¡×¤×™× ×©×œ×™</title>
    
    <meta name="description" content="× ×™×”×•×œ ×—×›× ×©×œ ×—×©×‘×•× ×•×ª ×•×ª× ×•×¢×•×ª ×¤×™× × ×¡×™×•×ª">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="×× ×”×œ ×›×¡×¤×™×">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ’°</text></svg>">
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Heebo', sans-serif;
        }

        .bank-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bank-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }

        .recurring-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .recurring-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .day-cell {
            transition: all 0.2s ease;
            position: relative;
        }
        .day-cell:hover:not(.empty-cell) {
            background-color: #f8fafc !important;
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            z-index: 10;
        }
        
        .day-cell.positive-balance {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        
        .day-cell.negative-balance {
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-animate { animation: slideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .backdrop-animate { animation: fadeIn 0.2s ease-out; }

        @media (max-width: 768px) {
            .day-cell { min-height: 85px !important; padding: 8px 6px !important; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-bounce {
            animation: bounce 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×§×™×™××•×ª ---
        const formatCurrency = (amount) => new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        const formatCurrencyCompact = (amount) => Math.abs(amount) >= 10000 ? (amount / 1000).toFixed(1) + 'K â‚ª' : formatCurrency(amount);
        const formatDate = (dateStr) => { const [year, month, day] = dateStr.split('-'); return `${day}/${month}/${year}`; };
        const getDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const generateRecurringInstances = (recurring, monthsAhead = 12) => {
            const instances = [];
            const startDate = new Date(recurring.startDate);
            const endDate = recurring.endDate ? new Date(recurring.endDate) : null;
            let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), recurring.dayOfMonth);
            if (currentDate < startDate) currentDate.setMonth(currentDate.getMonth() + 1);
            const limitDate = new Date(); limitDate.setMonth(limitDate.getMonth() + monthsAhead);
            while (currentDate <= limitDate) {
                if (currentDate >= startDate && (!endDate || currentDate <= endDate)) {
                    instances.push({ id: `recurring-${recurring.id}-${getDateKey(currentDate)}`, date: getDateKey(currentDate), bankId: recurring.bankId, amount: recurring.amount, description: recurring.description, type: recurring.type, isRecurring: true });
                }
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            return instances;
        };

        // --- ×¨×›×™×‘×™× ×§×™×™××™× ×œ×œ× ×©×™× ×•×™ ---
        const BankCard = ({ bank, onUpdate, onDelete, canDelete }) => (
            <div className="bank-card bg-white rounded-xl p-5 shadow-md border-2 border-gray-100 hover:border-blue-200">
                <div className="flex items-center gap-2 mb-3">
                    <span className="text-2xl">ğŸ¦</span>
                    <input type="text" value={bank.name} onChange={(e) => onUpdate(bank.id, 'name', e.target.value)} className="flex-1 font-semibold text-gray-800 outline-none bg-transparent" />
                </div>
                <div className="mb-4">
                    <label className="text-xs text-gray-500 mb-1 block">ğŸ’° ×™×ª×¨×” ×”×ª×—×œ×ª×™×ª</label>
                    <input type="number" value={bank.initialBalance} onChange={(e) => onUpdate(bank.id, 'initialBalance', Number(e.target.value))} className="w-full bg-gray-50 rounded-lg px-3 py-2 border border-gray-200 font-mono" />
                </div>
                <div className="flex items-center justify-between pt-3 border-t">
                    <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-400">ğŸ¨ ×¦×‘×¢:</span>
                        <input type="color" value={bank.color} onChange={(e) => onUpdate(bank.id, 'color', e.target.value)} className="w-8 h-8 rounded-lg cursor-pointer" />
                    </div>
                    {canDelete && <button onClick={() => onDelete(bank.id)} className="text-red-500 hover:scale-110 transition-transform" title="××—×§ ×—×©×‘×•×Ÿ">ğŸ—‘ï¸</button>}
                </div>
            </div>
        );

        const RecurringCard = ({ recurring, banks, onEdit, onDelete }) => {
            const [isEditing, setIsEditing] = useState(false);
            if (isEditing) return <RecurringForm recurring={recurring} banks={banks} onSave={(data) => { onEdit(recurring.id, data); setIsEditing(false); }} onCancel={() => setIsEditing(false)} />;
            return (
                <div className="recurring-card bg-white rounded-xl p-4 shadow-md border-2 border-gray-100">
                    <div className="flex justify-between mb-3">
                        <h4 className="font-semibold text-gray-800">{recurring.description}</h4>
                        <span className={`font-bold ${recurring.amount >= 0 ? 'text-green-700' : 'text-red-600'}`}>{formatCurrency(recurring.amount)}</span>
                    </div>
                    <div className="text-xs text-gray-500 mb-3 space-y-1">
                        <div>ğŸ“… ×™×•× {recurring.dayOfMonth} ×œ×—×•×“×©</div>
                        <div>â±ï¸ ×-{formatDate(recurring.startDate)}{recurring.endDate ? ` ×¢×“ ${formatDate(recurring.endDate)}` : ''}</div>
                        <div>ğŸ’³ {banks.find(b => b.id === recurring.bankId)?.name}</div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setIsEditing(true)} className="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-medium hover:bg-blue-100">âœï¸ ×¢×¨×™×›×”</button>
                        <button onClick={() => onDelete(recurring.id)} className="flex-1 bg-red-50 text-red-600 py-2 rounded-lg text-sm font-medium hover:bg-red-100">ğŸ—‘ï¸ ××—×™×§×”</button>
                    </div>
                </div>
            );
        };

        const RecurringForm = ({ recurring, banks, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                bankId: recurring?.bankId || banks[0]?.id || '',
                description: recurring?.description || '',
                amount: recurring ? Math.abs(recurring.amount).toString() : '',
                type: recurring?.type || 'expense',
                dayOfMonth: recurring?.dayOfMonth || 1,
                startDate: recurring?.startDate || getDateKey(new Date()),
                endDate: recurring?.endDate || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.description.trim()) { alert('×™×© ×œ×”×–×™×Ÿ ×ª×™××•×¨'); return; }
                if (!formData.amount || Number(formData.amount) <= 0) { alert('×™×© ×œ×”×–×™×Ÿ ×¡×›×•× ×—×™×•×‘×™'); return; }
                const finalAmount = formData.type === 'expense' ? -Math.abs(Number(formData.amount)) : Math.abs(Number(formData.amount));
                onSave({ bankId: formData.bankId, description: formData.description.trim(), amount: finalAmount, type: formData.type, dayOfMonth: Number(formData.dayOfMonth), startDate: formData.startDate, endDate: formData.endDate || null });
            };

            return (
                <form onSubmit={handleSubmit} className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200 space-y-3">
                    <h4 className="font-bold text-gray-800">{recurring ? 'âœï¸ ×¢×¨×™×›×ª ×ª× ×•×¢×” ×—×•×–×¨×ª' : 'â• ×ª× ×•×¢×” ×—×•×–×¨×ª ×—×“×©×”'}</h4>
                    <div className="flex gap-2">
                        <button type="button" onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-2 rounded-lg font-medium ${formData.type === 'income' ? 'bg-green-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>ğŸ’° ×”×›× ×¡×”</button>
                        <button type="button" onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-2 rounded-lg font-medium ${formData.type === 'expense' ? 'bg-red-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>ğŸ’¸ ×”×•×¦××”</button>
                    </div>
                    <select value={formData.bankId} onChange={(e) => setFormData({...formData, bankId: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white">
                        {banks.map(b => <option key={b.id} value={b.id}>ğŸ’³ {b.name}</option>)}
                    </select>
                    <input type="text" value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} placeholder="âœï¸ ×ª×™××•×¨" className="w-full p-2 border rounded-lg text-sm" />
                    <div className="flex gap-2">
                        <input type="number" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} placeholder="â‚ª ×¡×›×•×" className="flex-1 p-2 border rounded-lg text-sm font-mono" step="0.01" />
                        <input type="number" value={formData.dayOfMonth} onChange={(e) => setFormData({...formData, dayOfMonth: e.target.value})} placeholder="×™×•×" min="1" max="31" className="w-20 p-2 border rounded-lg text-sm text-center font-bold" />
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-xs text-gray-600 block mb-1">ğŸ“… ××ª××¨×™×š</label><input type="date" value={formData.startDate} onChange={(e) => setFormData({...formData, startDate: e.target.value})} className="w-full p-2 border rounded-lg text-sm" /></div>
                        <div><label className="text-xs text-gray-600 block mb-1">ğŸ ×¢×“ ×ª××¨×™×š</label><input type="date" value={formData.endDate} onChange={(e) => setFormData({...formData, endDate: e.target.value})} className="w-full p-2 border rounded-lg text-sm" /></div>
                    </div>
                    <div className="flex gap-2">
                        <button type="submit" className="flex-1 bg-purple-600 text-white py-2 rounded-lg font-semibold text-sm hover:bg-purple-700 shadow-sm">âœ… ×©××•×¨</button>
                        {onCancel && <button type="button" onClick={onCancel} className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-semibold text-sm hover:bg-gray-300">âŒ ×‘×™×˜×•×œ</button>}
                    </div>
                </form>
            );
        };

        const CurrencyConverter = ({ usdRate }) => {
            const [usdAmount, setUsdAmount] = useState('');
            const [ilsAmount, setIlsAmount] = useState('');
            const handleUsdChange = (v) => { setUsdAmount(v); if(v && !isNaN(v)) setIlsAmount((parseFloat(v) * usdRate).toFixed(2)); else setIlsAmount(''); };
            const handleIlsChange = (v) => { setIlsAmount(v); if(v && !isNaN(v)) setUsdAmount((parseFloat(v) / usdRate).toFixed(2)); else setUsdAmount(''); };
            return (
                <div className="inline-flex items-center gap-3 bg-white px-4 py-2 rounded-xl border border-gray-200 shadow-sm">
                    <div className="flex items-center gap-2"><span>ğŸ’µ</span><input type="number" value={usdAmount} onChange={e => handleUsdChange(e.target.value)} placeholder="USD" className="w-20 px-2 py-1 text-sm border rounded bg-blue-50 text-center font-mono outline-none" /></div>
                    <span className="text-gray-400">â‡„</span>
                    <div className="flex items-center gap-2"><span>â‚ª</span><input type="number" value={ilsAmount} onChange={e => handleIlsChange(e.target.value)} placeholder="ILS" className="w-20 px-2 py-1 text-sm border rounded bg-green-50 text-center font-mono outline-none" /></div>
                </div>
            );
        };

        const DayCell = ({ day, balance, hasNegativeBank, hasTransactions, hasRecurring, isToday, isEmpty, onClick }) => {
            if (isEmpty) return <div className="min-h-[100px] bg-gray-50 border border-gray-100"></div>;
            return (
                <div onClick={onClick} className={`day-cell min-h-[120px] p-3 border border-gray-200 cursor-pointer flex flex-col ${balance >= 0 ? 'positive-balance' : 'negative-balance'} ${isToday ? '!bg-blue-50 border-2 !border-blue-400 shadow-inner' : ''}`}>
                    <div className="flex justify-between items-start mb-2">
                        <span className={`text-sm font-semibold ${isToday ? 'text-blue-700' : 'text-gray-700'}`}>{day}</span>
                        <div className="flex gap-1">
                            {hasTransactions && <div className="w-2 h-2 bg-green-500 rounded-full"></div>}
                            {hasRecurring && <div className="w-2 h-2 bg-purple-500 rounded-full"></div>}
                        </div>
                    </div>
                    <div className="flex-1 flex items-center justify-center font-bold text-sm">
                        <span className={hasNegativeBank ? 'text-red-600' : (balance >= 0 ? 'text-green-700' : 'text-red-600')}>{formatCurrencyCompact(balance)}</span>
                    </div>
                </div>
            );
        };

        const TransactionModal = ({ date, banks, allTransactions, onClose, onAddTransaction, onDeleteTransaction, onAddTransfer, onUpdateTransaction }) => {
            const [selectedBank, setSelectedBank] = useState(banks[0]?.id || '');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [type, setType] = useState('expense');
            const [activeTab, setActiveTab] = useState('add');
            const [editingId, setEditingId] = useState(null);
            const [fromBank, setFromBank] = useState(banks[0]?.id || '');
            const [toBank, setToBank] = useState(banks[1]?.id || banks[0]?.id);
            const [transferAmount, setTransferAmount] = useState('');
            const [transferDescription, setTransferDescription] = useState('ğŸ”„ ×”×¢×‘×¨×”');

            const dayTransactions = allTransactions.filter(t => t.date === date);
            const bankBalances = banks.map(bank => ({ ...bank, balance: bank.initialBalance + allTransactions.filter(t => t.bankId === bank.id && t.date <= date).reduce((sum, t) => sum + t.amount, 0) }));

            const startEdit = (tx) => { setEditingId(tx.id); setDescription(tx.description); setAmount(Math.abs(tx.amount).toString()); setType(tx.amount >= 0 ? 'income' : 'expense'); setSelectedBank(tx.bankId); setActiveTab('add'); };
            const resetForm = () => { setEditingId(null); setDescription(''); setAmount(''); setType('expense'); };

            return (
                <>
                    <div className="backdrop-animate fixed inset-0 bg-black/40 backdrop-blur-sm z-40" onClick={onClose}></div>
                    <div className="modal-animate fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-3xl shadow-2xl w-[95%] max-w-lg z-50 overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-blue-600 p-5 text-white flex justify-between items-center"><h2 className="text-xl font-bold">ğŸ“… {formatDate(date)}</h2><button onClick={onClose} className="bg-white/20 hover:bg-white/40 w-8 h-8 rounded-full flex items-center justify-center">âœ•</button></div>
                        <div className="flex border-b text-center font-bold">
                            {[{id:'add',label: editingId ? 'âœï¸ ×¢×¨×™×›×”' : 'â• ×”×•×¡×¤×”'},{id:'transfer',label:'ğŸ”„ ×”×¢×‘×¨×”'},{id:'tx',label:'ğŸ“ ×ª× ×•×¢×•×ª'},{id:'bal',label:'ğŸ’° ×™×ª×¨×•×ª'}].map(tab => (
                                <button key={tab.id} onClick={() => { setActiveTab(tab.id); if(tab.id !== 'add') resetForm(); }} className={`flex-1 py-3 text-sm ${activeTab === tab.id ? 'border-b-4 border-blue-600 text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}`}>{tab.label}</button>
                            ))}
                        </div>
                        <div className="p-5 overflow-y-auto">
                            {activeTab === 'add' && (
                                <form className="space-y-4" onSubmit={e => { e.preventDefault(); const txData = { id: editingId || Date.now().toString(), date, bankId: selectedBank, amount: type === 'expense' ? -Math.abs(Number(amount)) : Math.abs(Number(amount)), description, isRecurring: false }; if(editingId) onUpdateTransaction(txData); else onAddTransaction(txData); onClose(); }}>
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setType('expense')} className={`flex-1 py-3 rounded-xl font-bold ${type === 'expense' ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 text-gray-500'}`}>ğŸ’¸ ×”×•×¦××”</button>
                                        <button type="button" onClick={() => setType('income')} className={`flex-1 py-3 rounded-xl font-bold ${type === 'income' ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-100 text-gray-500'}`}>ğŸ’° ×”×›× ×¡×”</button>
                                    </div>
                                    <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="âœï¸ ×ª×™××•×¨" className="w-full p-3 border-2 rounded-xl outline-none" required />
                                    <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="â‚ª ×¡×›×•×" className="w-full p-3 border-2 rounded-xl font-mono outline-none" required />
                                    <select value={selectedBank} onChange={e => setSelectedBank(e.target.value)} className="w-full p-3 border-2 rounded-xl bg-white">{banks.map(b => <option key={b.id} value={b.id}>ğŸ¦ {b.name}</option>)}</select>
                                    <div className="flex gap-2 pt-2">
                                        <button type="submit" className="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-md hover:bg-blue-700">âœ… {editingId ? '×¢×“×›×Ÿ ×ª× ×•×¢×”' : '×©××•×¨ ×ª× ×•×¢×”'}</button>
                                        {editingId && <button type="button" onClick={resetForm} className="bg-gray-200 text-gray-700 px-6 rounded-xl">âŒ ×‘×˜×œ</button>}
                                    </div>
                                </form>
                            )}
                            {activeTab === 'transfer' && (
                                <form className="space-y-4" onSubmit={e => { e.preventDefault(); if (fromBank === toBank) { alert('×œ× × ×™×ª×Ÿ ×œ×”×¢×‘×™×¨ ×œ××•×ª×• ×—×©×‘×•×Ÿ'); return; } onAddTransfer(fromBank, toBank, Number(transferAmount), transferDescription); onClose(); }}>
                                    <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200 space-y-3">
                                        <h4 className="font-bold text-center mb-4 text-purple-800">ğŸ”„ ×”×¢×‘×¨×” ×‘×™×Ÿ ×—×©×‘×•× ×•×ª</h4>
                                        <div><label className="text-xs font-bold text-purple-600 block mb-1">ğŸ“¤ ××—×©×‘×•×Ÿ</label><select value={fromBank} onChange={e => setFromBank(e.target.value)} className="w-full p-3 border-2 rounded-xl bg-white">{banks.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select></div>
                                        <div className="text-center text-2xl">â¬‡ï¸</div>
                                        <div><label className="text-xs font-bold text-purple-600 block mb-1">ğŸ“¥ ×œ×—×©×‘×•×Ÿ</label><select value={toBank} onChange={e => setToBank(e.target.value)} className="w-full p-3 border-2 rounded-xl bg-white">{banks.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select></div>
                                        <div><label className="text-xs font-bold text-purple-600 block mb-1">â‚ª ×¡×›×•× ×”×¢×‘×¨×”</label><input type="number" value={transferAmount} onChange={e => setTransferAmount(e.target.value)} placeholder="0.00" className="w-full p-3 border-2 rounded-xl font-mono" step="0.01" required /></div>
                                        <div><label className="text-xs font-bold text-purple-600 block mb-1">âœï¸ ×ª×™××•×¨</label><input type="text" value={transferDescription} onChange={e => setTransferDescription(e.target.value)} placeholder="×”×¢×‘×¨×”" className="w-full p-3 border-2 rounded-xl" /></div>
                                    </div>
                                    <button type="submit" className="w-full bg-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-purple-700">ğŸš€ ×‘×¦×¢ ×”×¢×‘×¨×”</button>
                                </form>
                            )}
                            {activeTab === 'tx' && (
                                <div className="space-y-3">
                                    {dayTransactions.length === 0 ? <div className="text-center py-10 text-gray-400 italic">××™×Ÿ ×ª× ×•×¢×•×ª ×‘×™×•× ×–×”</div> : dayTransactions.map(tx => {
                                        const isTransfer = !!tx.transferId;
                                        const linkedBank = isTransfer ? (tx.transferTo ? banks.find(b => b.id === tx.transferTo) : banks.find(b => b.id === tx.transferFrom)) : null;
                                        return (
                                            <div key={tx.id} className={`flex justify-between items-center p-3 rounded-xl border-2 ${isTransfer ? 'bg-purple-50 border-purple-100' : 'bg-gray-50 border-gray-100'}`}>
                                                <div className="flex-1"><div className="flex items-center gap-2"><span className="text-lg">{isTransfer ? 'ğŸ”„' : (tx.amount >= 0 ? 'ğŸ’°' : 'ğŸ’¸')}</span><span className="font-semibold text-gray-800">{tx.description}</span></div>{isTransfer && linkedBank && <div className="text-xs text-purple-600 font-medium mr-7">{tx.transferTo ? `â¬…ï¸ × ×©×œ×— ××œ ${linkedBank.name}` : `â¡ï¸ ×”×ª×§×‘×œ ×-${linkedBank.name}`}</div>}<div className="text-[10px] text-gray-400 mr-7">{banks.find(b => b.id === tx.bankId)?.name}</div></div>
                                                <div className="flex gap-1 items-center"><span className={`font-bold ml-2 ${tx.amount >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(tx.amount)}</span>{!tx.isRecurring && <div className="flex bg-white rounded-lg shadow-sm border overflow-hidden">{!isTransfer && <button onClick={() => startEdit(tx)} className="p-2 hover:bg-blue-50 text-blue-500">âœï¸</button>}<button onClick={() => onDeleteTransaction(tx.id)} className="p-2 hover:bg-red-50 text-red-400 border-r">ğŸ—‘ï¸</button></div>}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                            {activeTab === 'bal' && (
                                <div className="space-y-3 bg-gray-50 p-4 rounded-2xl border-2 border-gray-100">
                                    {bankBalances.map(b => (
                                        <div key={b.id} className="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border"><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: b.color}}></div><span className="font-bold text-gray-700">{b.name}</span></div><span className={`font-mono font-bold ${b.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(b.balance)}</span></div>
                                    ))}
                                    <div className="pt-3 border-t-2 flex justify-between items-center px-3"><span className="font-black text-gray-900">×¡×”"×› ×™×ª×¨×”:</span><span className={`font-mono font-black text-lg ${bankBalances.reduce((s,b)=>s+b.balance,0) >= 0 ? 'text-green-700' : 'text-red-700'}`}>{formatCurrency(bankBalances.reduce((s,b)=>s+b.balance,0))}</span></div>
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        // --- ×”×•×¡×¤×ª ×¨×›×™×‘ × ×™×”×•×œ ×¡×™×¡××” ---
        const PasswordSection = () => {
            const [isChanging, setIsChanging] = useState(false);
            const [newPass, setNewPass] = useState('');
            
            const handleSave = () => {
                if (!newPass) {
                    if (confirm('××—×™×§×ª ×”×¡×™×¡××” ×ª×”×¤×•×š ××ª ×”××¤×œ×™×§×¦×™×” ×œ×—×•×¤×©×™×ª ×œ×›×œ ××™ ×©×™×¤×ª×— ××•×ª×”. ×œ×”××©×™×š?')) {
                        localStorage.removeItem('finance_app_password');
                        alert('×”×¡×™×¡××” ×”×•×¡×¨×”');
                        setIsChanging(false);
                    }
                } else {
                    localStorage.setItem('finance_app_password', newPass);
                    alert('×”×¡×™×¡××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
                    setIsChanging(false);
                    setNewPass('');
                }
            };

            return (
                <div className="mb-10 bg-white border-2 border-orange-100 rounded-3xl p-6 shadow-sm">
                    <h3 className="text-xl font-bold flex items-center gap-2 mb-4">ğŸ” ××‘×˜×—×ª ×—×©×‘×•×Ÿ</h3>
                    {!isChanging ? (
                        <button onClick={() => setIsChanging(true)} className="bg-orange-50 text-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-100 transition-all flex items-center gap-2">
                            <span>ğŸ”‘</span> ×”×’×“×¨ / ×©× ×” ×¡×™×¡××ª ×›× ×™×¡×”
                        </button>
                    ) : (
                        <div className="flex flex-col sm:flex-row gap-3">
                            <input 
                                type="password" 
                                value={newPass} 
                                onChange={e => setNewPass(e.target.value)} 
                                placeholder="×¡×™×¡××” ×—×“×©×” (×”×©××¨ ×¨×™×§ ×œ×‘×™×˜×•×œ)" 
                                className="flex-1 p-3 border-2 rounded-xl outline-none focus:border-orange-400"
                            />
                            <div className="flex gap-2">
                                <button onClick={handleSave} className="bg-orange-600 text-white px-6 py-3 rounded-xl font-bold">×©××•×¨</button>
                                <button onClick={() => setIsChanging(false)} className="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold">×‘×™×˜×•×œ</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- ×¨×›×™×‘ ×”××¤×œ×™×§×¦×™×” ×”××§×•×¨×™ (×œ×œ× ×©×™× ×•×™×™× ×‘×œ×•×’×™×§×” ×”×¤× ×™××™×ª) ---
        const FinanceApp = () => {
            const [banks, setBanks] = useState(() => JSON.parse(localStorage.getItem('finance_banks')) || [{ id: '1', name: '×—×©×‘×•×Ÿ ×¢×•"×©', color: '#3b82f6', initialBalance: 0 }]);
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('finance_transactions')) || []);
            const [recurringTransactions, setRecurringTransactions] = useState(() => JSON.parse(localStorage.getItem('finance_recurring')) || []);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [showAddRecurring, setShowAddRecurring] = useState(false);
            const [selectedBankFilter, setSelectedBankFilter] = useState('all');
            const [usdRate, setUsdRate] = useState(null);
            const [usdUpdateTime, setUsdUpdateTime] = useState(null);
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);

            const onTouchStart = (e) => { setTouchEnd(null); setTouchStart(e.targetTouches[0].clientX); };
            const onTouchMove = (e) => { setTouchEnd(e.targetTouches[0].clientX); };
            const onTouchEnd = () => { if (!touchStart || !touchEnd) return; const distance = touchStart - touchEnd; if (distance > 50) changeMonth(-1); if (distance < -50) changeMonth(1); };
            const changeMonth = (delta) => { const newDate = new Date(currentDate); newDate.setMonth(newDate.getMonth() + delta); setCurrentDate(newDate); };

            useEffect(() => { localStorage.setItem('finance_banks', JSON.stringify(banks)); }, [banks]);
            useEffect(() => { localStorage.setItem('finance_transactions', JSON.stringify(transactions)); }, [transactions]);
            useEffect(() => { localStorage.setItem('finance_recurring', JSON.stringify(recurringTransactions)); }, [recurringTransactions]);

            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/USD')
                    .then(res => res.json())
                    .then(data => { if (data.rates && data.rates.ILS) { setUsdRate(data.rates.ILS.toFixed(2)); setUsdUpdateTime(new Date().toLocaleString('he-IL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })); } })
                    .catch(() => {});
            }, []);

            const allTransactions = useMemo(() => [...transactions, ...recurringTransactions.flatMap(r => generateRecurringInstances(r))], [transactions, recurringTransactions]);

            const calendarData = useMemo(() => {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push({ isEmpty: true, key: `empty-${i}` });
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = getDateKey(new Date(year, month, day));
                    const bankBalances = banks.map(bank => ({ bankId: bank.id, balance: bank.initialBalance + allTransactions.filter(t => t.bankId === bank.id && t.date <= dateKey).reduce((s, t) => s + t.amount, 0) }));
                    const hasNegativeBank = bankBalances.some(b => b.balance < 0);
                    const totalBalance = bankBalances.reduce((sum, b) => sum + b.balance, 0);
                    const displayBalance = selectedBankFilter === 'all' ? totalBalance : bankBalances.find(b => b.bankId === selectedBankFilter)?.balance || 0;
                    days.push({ day, dateKey, balance: displayBalance, hasNegativeBank: hasNegativeBank && selectedBankFilter === 'all', hasTransactions: transactions.some(t => t.date === dateKey), hasRecurring: allTransactions.some(t => t.date === dateKey && t.isRecurring), isToday: dateKey === getDateKey(new Date()), key: dateKey });
                }
                return days;
            }, [currentDate, banks, allTransactions, transactions, selectedBankFilter]);

            const exportData = () => { const blob = new Blob([JSON.stringify({ banks, transactions, recurringTransactions })], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `finance_backup_${getDateKey(new Date())}.json`; a.click(); };
            const importData = (e) => { const reader = new FileReader(); reader.onload = (evt) => { const data = JSON.parse(evt.target.result); if (confirm('×–×” ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×. ×œ×”××©×™×š?')) { setBanks(data.banks); setTransactions(data.transactions); setRecurringTransactions(data.recurringTransactions); } }; reader.readAsText(e.target.files[0]); };
            const addRecurring = (data) => { setRecurringTransactions([...recurringTransactions, { ...data, id: Date.now().toString() }]); setShowAddRecurring(false); };
            const editRecurring = (id, data) => { setRecurringTransactions(recurringTransactions.map(r => r.id === id ? { ...r, ...data } : r)); };
            const deleteRecurring = (id) => { const r = recurringTransactions.find(r => r.id === id); if (confirm(`×œ××—×•×§ ××ª "${r.description}"?`)) { setRecurringTransactions(recurringTransactions.filter(rt => rt.id !== id)); if(confirm("×œ××—×•×§ ×’× ×”×™×¡×˜×•×¨×™×”?")) setTransactions(transactions.filter(t => t.recurringId !== id)); } };

            return (
                <div className="max-w-7xl mx-auto p-4 sm:p-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center gap-2"><span className="text-4xl animate-bounce">ğŸ’°</span> <span className="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">×× ×”×œ ×”×›×¡×¤×™× ×©×œ×™</span></h1>
                    <div className="bg-white rounded-3xl shadow-xl overflow-hidden border-2 mb-12">
                        <div className="bg-blue-600 p-6 flex justify-between items-center text-white"><button onClick={() => changeMonth(1)} className="text-2xl bg-white/20 hover:bg-white/40 w-10 h-10 rounded-xl transition-colors">â¬…</button><div className="text-center"><h2 className="text-xl sm:text-3xl font-black">{currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}</h2><button onClick={() => setCurrentDate(new Date())} className="text-[10px] bg-white/20 px-3 py-1 rounded-full mt-2 hover:bg-white/30">ğŸ  ×—×–×•×¨ ×œ×”×™×•×</button></div><button onClick={() => changeMonth(-1)} className="text-2xl bg-white/20 hover:bg-white/40 w-10 h-10 rounded-xl transition-colors">â¡</button></div>
                        <div className="bg-gray-50 px-4 py-4 border-b flex items-center justify-center gap-3"><span className="text-sm font-bold text-gray-500">ğŸ‘€ ×ª×¦×•×’×ª ×—×©×‘×•×Ÿ:</span><select value={selectedBankFilter} onChange={(e) => setSelectedBankFilter(e.target.value)} className="bg-white border-2 border-gray-200 rounded-xl px-4 py-2 text-sm font-bold outline-none focus:border-blue-500 shadow-sm"><option value="all">ğŸ’ ×›×œ ×”×—×©×‘×•× ×•×ª</option>{banks.map(bank => <option key={bank.id} value={bank.id}>ğŸ¦ {bank.name}</option>)}</select></div>
                        <div className="grid grid-cols-7 bg-gray-100 border-b text-center font-black py-4 text-gray-400 text-xs">{['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'].map(d => <div key={d} className="hidden sm:block">{d}</div>)}{['×','×‘','×’','×“','×”','×•','×©'].map(d => <div key={d} className="sm:hidden">{d}</div>)}</div>
                        <div className="grid grid-cols-7" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>{calendarData.map(d => <DayCell key={d.key} {...d} onClick={() => !d.isEmpty && setSelectedDate(d.dateKey)} />)}</div>
                    </div>
                    <div className="pt-8 border-t-4 border-gray-100">
                        <h2 className="text-2xl font-black text-gray-800 mb-8 text-center flex items-center justify-center gap-2"><span>âš™ï¸</span> ×”×’×“×¨×•×ª ×•× ×™×”×•×œ</h2>
                        <div className="mb-10"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold flex items-center gap-2">ğŸ¦ × ×™×”×•×œ ×—×©×‘×•× ×•×ª ×‘× ×§</h3><button onClick={() => setBanks([...banks, { id: Date.now().toString(), name: '×—×©×‘×•×Ÿ ×—×“×©', color: '#6366f1', initialBalance: 0 }])} className="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold shadow-md hover:bg-blue-700">â• ×”×•×¡×£ ×—×©×‘×•×Ÿ</button></div><div className="grid grid-cols-1 sm:grid-cols-3 gap-6">{banks.map(b => <BankCard key={b.id} bank={b} onUpdate={(id, f, v) => setBanks(banks.map(bk => bk.id === id ? {...bk, [f]: v} : bk))} onDelete={id => setBanks(banks.filter(bk => bk.id !== id))} canDelete={banks.length > 1} />)}</div></div>
                        <div className="mb-10"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold flex items-center gap-2">ğŸ”„ ×ª× ×•×¢×•×ª ×—×•×–×¨×•×ª (×§×‘×•×¢×•×ª)</h3><button onClick={() => setShowAddRecurring(!showAddRecurring)} className={`px-5 py-2 rounded-xl font-bold shadow-md transition-all ${showAddRecurring ? 'bg-gray-500 text-white' : 'bg-purple-600 text-white hover:bg-purple-700'}`}>{showAddRecurring ? 'âœ• ×‘×™×˜×•×œ' : '+ ×”×•×¡×£ ×ª× ×•×¢×” ×—×•×–×¨×ª'}</button></div>{showAddRecurring && <div className="mb-6"><RecurringForm banks={banks} onSave={addRecurring} onCancel={() => setShowAddRecurring(false)} /></div>}{recurringTransactions.length === 0 ? <div className="bg-purple-50 border-2 border-dashed border-purple-200 rounded-3xl p-10 text-center"><div className="text-5xl mb-4">ğŸ”„</div><p className="text-purple-800 font-bold mb-1 text-lg">××™×Ÿ ×ª× ×•×¢×•×ª ×—×•×–×¨×•×ª ××•×’×“×¨×•×ª</p></div> : <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">{recurringTransactions.map(r => <RecurringCard key={r.id} recurring={r} banks={banks} onEdit={editRecurring} onDelete={deleteRecurring} />)}</div>}</div>
                        
                        <div className="flex flex-col sm:flex-row gap-3 justify-center py-6 border-t border-dashed border-gray-200">
                            <button onClick={exportData} className="bg-gradient-to-r from-gray-700 to-gray-800 text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md text-sm"><span>ğŸ’¾</span> ×’×™×‘×•×™ × ×ª×•× ×™×</button>
                            <label className="bg-white text-gray-700 border-2 border-gray-200 px-6 py-3 rounded-xl font-bold cursor-pointer text-center flex items-center justify-center gap-2 shadow-sm text-sm"><span>ğŸ“‚</span> ×©×—×–×•×¨ × ×ª×•× ×™×<input type="file" onChange={importData} className="hidden" /></label>
                        </div>
                        
                        {/* ×”×•×¡×¤×ª ×¡×¢×™×£ ×”×¡×™×¡××” ×”×—×“×© */}
                        <PasswordSection />

                        {usdRate && <div className="text-center pb-6 space-y-4"><div className="inline-flex items-center gap-2 bg-gradient-to-r from-green-50 to-emerald-50 px-5 py-2.5 rounded-xl border border-green-200 shadow-sm"><span>ğŸ’µ</span><span className="text-sm font-medium text-gray-600">×©×¢×¨:</span><span className="font-bold text-green-700">$1 = â‚ª{usdRate}</span></div><br/><CurrencyConverter usdRate={usdRate} /></div>}
                    </div>
                    {selectedDate && <TransactionModal date={selectedDate} banks={banks} allTransactions={allTransactions} onClose={() => setSelectedDate(null)} onAddTransaction={t => setTransactions([...transactions, t])} onUpdateTransaction={updatedTx => setTransactions(transactions.map(t => t.id === updatedTx.id ? updatedTx : t))} onDeleteTransaction={(id) => { const transaction = transactions.find(t => t.id === id); if (transaction?.transferId) { if (confirm('×œ××—×•×§ ×”×¢×‘×¨×”?')) setTransactions(transactions.filter(t => t.transferId !== transaction.transferId)); } else setTransactions(transactions.filter(tx => tx.id !== id)); }} onAddTransfer={(fromBankId, toBankId, amount, description) => { const transferId = `transfer-${Date.now()}`; const common = { date: selectedDate, isRecurring: false, transferId }; setTransactions([...transactions, { ...common, id: `${transferId}-out`, bankId: fromBankId, amount: -Math.abs(amount), description: description || 'ğŸ”„ ×”×¢×‘×¨×”', transferTo: toBankId }, { ...common, id: `${transferId}-in`, bankId: toBankId, amount: Math.abs(amount), description: description || 'ğŸ”„ ×”×¢×‘×¨×”', transferFrom: fromBankId }]); }} />}
                </div>
            );
        };

        // --- ×¨×›×™×‘ ×”×’× ×” ×—×“×© ×”×¢×•×˜×£ ××ª ×”××¤×œ×™×§×¦×™×” ---
        const PasswordProtector = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [inputPass, setInputPass] = useState('');
            const [error, setError] = useState(false);
            
            const savedPass = localStorage.getItem('finance_app_password');

            // ×× ××™×Ÿ ×¡×™×¡××” ××•×’×“×¨×ª, ×”×›× ×¡ ×™×©×¨
            useEffect(() => {
                if (!savedPass) {
                    setIsAuthenticated(true);
                }
            }, [savedPass]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (inputPass === savedPass) {
                    setIsAuthenticated(true);
                    setError(false);
                } else {
                    setError(true);
                    setInputPass('');
                }
            };

            if (isAuthenticated) return <FinanceApp />;

            return (
                <div className="fixed inset-0 bg-blue-600 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
                        <div className="text-6xl mb-4">ğŸ”</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">×× ×”×œ ×”×›×¡×¤×™× × ×¢×•×œ</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="password" 
                                value={inputPass} 
                                onChange={e => setInputPass(e.target.value)}
                                placeholder="×”×–×Ÿ ×¡×™×¡××”"
                                className={`w-full p-4 border-2 rounded-2xl text-center text-xl outline-none transition-all ${error ? 'border-red-500 bg-red-50' : 'border-gray-200 focus:border-blue-500'}`}
                                autoFocus
                            />
                            {error && <p className="text-red-500 text-sm font-bold">×¡×™×¡××” ×©×’×•×™×”, × ×¡×” ×©×•×‘</p>}
                            <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-blue-700 transition-colors shadow-lg">×›× ×™×¡×”</button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PasswordProtector />);
    </script>

    <script>
        const manifestData = {
            name: "×× ×”×œ ×”×›×¡×¤×™× ×©×œ×™",
            short_name: "×× ×”×œ ×›×¡×¤×™×",
            description: "× ×™×”×•×œ ×—×›× ×©×œ ×—×©×‘×•× ×•×ª ×•×ª× ×•×¢×•×ª ×¤×™× × ×¡×™×•×ª",
            start_url: window.location.pathname,
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#3b82f6",
            orientation: "portrait",
            dir: "rtl",
            lang: "he",
            icons: [{ src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ’°</text></svg>", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
</body>
</html>
